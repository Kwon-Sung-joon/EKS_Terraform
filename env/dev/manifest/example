
#Create aws elb controller sa
kubectl create sa aws-load-balancer-controller -n kube-system
kubectl annotate serviceaccount -n kube-system aws-load-balancer-controller eks.amazonaws.com/role-arn=arn:aws:iam::672956273056:role/irsa_aws_load_balancer_controller

#Install elb helm
helm repo add eks https://aws.github.io/eks-charts
helm install aws-load-balancer-controller eks/aws-load-balancer-controller -n kube-system --set clusterName=dev_cluster_1 --set serviceAccount.create=false --set serviceAccount.name=aws-load-balancer-controller


#Create karpenter sa
kubectl create sa karpenter -n kube-system
kubectl annotate karpenter -n kube-system karpenter eks.amazonaws.com/role-arn=arn:aws:iam::672956273056:role/irsa_karpenter_controller


#Install karpenter helm using IRSA
helm upgrade --install --namespace kube-system karpenter oci://public.ecr.aws/karpenter/karpenter \
  --set serviceAccount.annotations."eks\.amazonaws\.com/role-arn"=${KARPENTER_IAM_ROLE_ARN} \
  --version v0.28.0 \
  --set settings.aws.clusterName=dev_cluster_1 \
  --set settings.aws.clusterEndpoint=${CLUSTER_ENDPOINT} \
  --set settings.aws.defaultInstanceProfile=dev_node_group_role \
  --set settings.aws.interruptionQueueName=dev_cluster_1\
  --wait


#Install karpenter helm using POD Identity

1. aws eks create-addon --cluster-name my-cluster --addon-name eks-pod-identity-agent --addon-version v1.0.0-eksbuild.1
2. aws eks create-pod-identity-association --cluster-name dev_cluster_1 --role-arn arn:aws:iam::111122223333:role/my-role --namespace kube-system --service-account karpenter

helm upgrade --install karpenter oci://public.ecr.aws/karpenter/karpenter --version v0.28.0 --namespace kube-system --create-namespace \
  --set "settings.clusterName=dev_cluster_1" \
  --set "settings.interruptionQueue=dev_cluster_1" \
  --set controller.resources.requests.cpu=1 \
  --set controller.resources.requests.memory=1Gi \
  --set controller.resources.limits.cpu=1 \
  --set controller.resources.limits.memory=1Gi \
  --wait